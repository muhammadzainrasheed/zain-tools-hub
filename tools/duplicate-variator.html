<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicate Variator â€” Zain Tools Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .variator-page {
            padding: 2rem;
            max-width: 1100px;
            margin: 0 auto;
        }
        .variator-wrap > h2 {
            display: flex;
            align-items: center;
            gap: .7rem;
            font-size: 1.9rem;
            font-weight: 900;
            color: #fff;
            margin-bottom: .4rem;
        }
        .variator-sub {
            color: rgba(255,255,255,.5);
            font-size: .92rem;
            margin-bottom: 1.4rem;
            max-width: 820px;
            line-height: 1.6;
        }

        /* â”€â”€ Language badges â”€â”€ */
        .lang-badges {
            display: flex;
            gap: .4rem;
            flex-wrap: wrap;
            margin-bottom: 1.4rem;
        }
        .lang-badge {
            display: inline-flex;
            align-items: center;
            gap: .3rem;
            font-size: .76rem;
            font-weight: 600;
            padding: .18rem .65rem;
            border-radius: 99px;
            background: rgba(255,255,255,.07);
            border: 1px solid rgba(255,255,255,.12);
            color: rgba(255,255,255,.55);
        }

        /* â”€â”€ Stats bar (chars + words only, no slider) â”€â”€ */
        .stats-bar {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background: rgba(255,255,255,.05);
            border: 1px solid rgba(255,255,255,.1);
            border-radius: 12px;
            padding: .75rem 1.2rem;
            margin-bottom: 1.3rem;
            font-size: .88rem;
            color: rgba(255,255,255,.55);
        }
        .stat-chip { display: flex; align-items: center; gap: .45rem; }
        .stat-chip span { font-weight: 800; color: #fff; font-size: 1rem; min-width: 28px; }

        /* â”€â”€ Two column grid â”€â”€ */
        .var-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1.2rem;
            margin-bottom: 1.2rem;
        }
        @media(max-width:780px) { .var-grid { grid-template-columns: 1fr; } }

        .section-label {
            display: block;
            font-size: .74rem;
            font-weight: 700;
            letter-spacing: .08em;
            text-transform: uppercase;
            color: rgba(255,255,255,.38);
            margin-bottom: .45rem;
        }

        .var-textarea {
            width: 100%;
            padding: .9rem 1rem;
            background: rgba(255,255,255,.05);
            border: 1px solid rgba(255,255,255,.13);
            border-radius: 11px;
            color: #fff;
            font-family: 'Inter', sans-serif;
            font-size: .91rem;
            line-height: 1.65;
            resize: vertical;
            outline: none;
            transition: border-color .2s, box-shadow .2s;
            box-sizing: border-box;
        }
        .var-textarea:focus { border-color: #a78bfa; }

        /* Output box â€” clickable to copy */
        .output-wrap { position: relative; cursor: pointer; }
        .output-wrap .var-textarea {
            background: rgba(255,255,255,.03);
            border-color: rgba(255,255,255,.08);
            cursor: pointer;
            transition: border-color .2s, background .2s;
        }
        .output-wrap:hover .var-textarea {
            border-color: rgba(167,139,250,.4);
            background: rgba(124,58,237,.06);
        }
        .output-wrap .click-hint {
            position: absolute;
            top: .6rem;
            right: .7rem;
            font-size: .7rem;
            color: rgba(255,255,255,.25);
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: .25rem;
        }
        .output-wrap.copied .var-textarea {
            border-color: #34d399;
            background: rgba(52,211,153,.06);
        }

        .char-row {
            display: flex;
            justify-content: space-between;
            margin-top: .3rem;
            font-size: .77rem;
            color: rgba(255,255,255,.32);
        }
        .char-row.over { color: #f87171 !important; font-weight: 700; }

        /* â”€â”€ Analysis box â”€â”€ */
        .dup-box {
            background: rgba(255,255,255,.03);
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 11px;
            padding: .9rem 1rem;
            min-height: 100%;
            font-size: .86rem;
            box-sizing: border-box;
        }
        .dup-empty { color: rgba(255,255,255,.25); margin: 0; font-style: italic; }
        .no-dup { color: #34d399; font-weight: 600; margin: 0; }
        .dup-box ul {
            list-style: none; margin: 0; padding: 0;
            display: flex; flex-direction: column; gap: .45rem;
        }
        .dup-box li {
            display: flex; align-items: center; gap: .5rem;
            color: rgba(255,255,255,.7); font-size: .84rem;
        }
        .dup-tag {
            display: inline-block;
            padding: .18rem .65rem;
            border-radius: 5px;
            font-weight: 700;
            font-size: .8rem;
        }
        .dup-action {
            margin-left: auto;
            font-size: .72rem;
            font-weight: 600;
            padding: .1rem .45rem;
            border-radius: 4px;
        }
        .dup-action.varied { color: #a78bfa; background: rgba(167,139,250,.12); }
        .dup-action.deleted { color: #fb923c; background: rgba(251,146,60,.12); }

        /* â”€â”€ Output label row â”€â”€ */
        .out-label-row {
            display: flex; align-items: center; gap: .6rem; margin-bottom: .45rem;
        }
        .out-badge {
            font-size: .7rem; font-weight: 700; padding: .18rem .6rem;
            border-radius: 4px; letter-spacing: .04em;
            background: rgba(124,58,237,.22); color: #c4b5fd;
            border: 1px solid rgba(124,58,237,.35);
        }

        /* â”€â”€ Actions â”€â”€ */
        .var-actions {
            display: flex; gap: .75rem; flex-wrap: wrap; margin-top: 1.3rem;
        }

        /* â”€â”€ Paste hint â”€â”€ */
        .paste-hint {
            display: inline-flex; align-items: center; gap: .4rem;
            font-size: .78rem; color: rgba(255,255,255,.3);
            margin-bottom: 1rem;
        }
        .paste-hint kbd {
            background: rgba(255,255,255,.1);
            border: 1px solid rgba(255,255,255,.15);
            border-radius: 4px;
            padding: .1rem .4rem;
            font-family: 'Inter', sans-serif;
            font-size: .72rem;
            color: rgba(255,255,255,.55);
        }
    </style>
</head>
<body>

<!-- ===== NAVIGATION ===== -->
<nav class="nav">
    <a href="../index.html" class="nav-brand">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
             stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
        </svg>
        Zain Tools
    </a>
    <button class="nav-toggle" onclick="document.querySelector('.nav-links').classList.toggle('open')">
        <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>
    <div class="nav-links">
        <a href="../index.html"           class="nav-btn">Home</a>
        <a href="word-changer.html"       class="nav-btn">Word Changer</a>
        <a href="asin-cleaner.html"       class="nav-btn">ASIN Cleaner</a>
        <a href="asin-splitter.html"      class="nav-btn">ASIN 900</a>
        <a href="voucher-tool.html"       class="nav-btn">Vouchers</a>
        <a href="duplicate-variator.html" class="nav-btn">Variator</a>
        <a href="search-optimizer.html"   class="nav-btn">Search Terms</a>
    </div>
</nav>

<!-- ===== PAGE ===== -->
<div class="variator-page">
<div class="variator-wrap">

    <h2>
        <svg width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
        </svg>
        Auto Duplicate Word Variator
    </h2>
    <p class="variator-sub">
        Paste your Amazon product title. Words repeated 3+ times are replaced with safe Unicode variants.
        Connector words (and, fÃ¼r, och, del, voorâ€¦) that cannot be converted are
        <strong style="color:#fb923c;">automatically removed</strong> if they repeat more than twice.
        Output is always in proper Title&nbsp;Case.
    </p>

    <!-- Language badges -->
    <div class="lang-badges">
        <span class="lang-badge">ğŸ‡¬ğŸ‡§ EN</span>
        <span class="lang-badge">ğŸ‡©ğŸ‡ª DE</span>
        <span class="lang-badge">ğŸ‡«ğŸ‡· FR</span>
        <span class="lang-badge">ğŸ‡ªğŸ‡¸ ES</span>
        <span class="lang-badge">ğŸ‡®ğŸ‡¹ IT</span>
        <span class="lang-badge">ğŸ‡³ğŸ‡± NL</span>
        <span class="lang-badge">ğŸ‡¸ğŸ‡ª SE</span>
    </div>

    <!-- Paste hint -->
    <div class="paste-hint">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
            <rect x="9" y="3" width="6" height="4" rx="1"/>
        </svg>
        Press <kbd>Ctrl+V</kbd> anywhere on this page to instantly paste your title
    </div>

    <!-- Stats bar (no slider) -->
    <div class="stats-bar">
        <div class="stat-chip">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M4 6h16M4 12h10M4 18h14"/>
            </svg>
            Input chars: <span id="inputCharCount">0</span>
        </div>
        <div class="stat-chip">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/>
            </svg>
            Words: <span id="inputWordCount">0</span>
        </div>
        <div class="stat-chip" style="margin-left:auto;">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Output chars: <span id="outputCharCount">0</span>
        </div>
    </div>

    <!-- Input + Analysis grid -->
    <div class="var-grid">
        <div>
            <label class="section-label">Input Title</label>
            <textarea id="varInput" class="var-textarea"
                placeholder="Paste your Amazon product title here (any language)..."
                style="min-height:170px;"></textarea>
            <div class="char-row" id="inputCharRow">
                <span id="inputCharLabel">0 / 200 characters</span>
                <span id="inputOverWarn" style="display:none;color:#f87171;font-weight:700;">âš  Over 200</span>
            </div>
        </div>
        <div style="display:flex;flex-direction:column;">
            <label class="section-label">Duplicate Analysis</label>
            <div id="dupInfo" class="dup-box" style="flex:1;">
                <p class="dup-empty">Paste a title to see analysis.</p>
            </div>
        </div>
    </div>

    <!-- Output -->
    <div class="output-wrap" id="outputWrap">
        <div class="out-label-row">
            <label class="section-label" style="margin:0;">Output Title</label>
            <span class="out-badge">PROCESSED</span>
        </div>
        <div class="click-hint">
            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            Click to copy
        </div>
        <textarea id="varOutput" class="var-textarea"
            style="min-height:110px;" readonly
            placeholder="Output appears here automatically..."></textarea>
        <div class="char-row">
            <span id="outputCharLabel">0 / 200 characters</span>
        </div>
    </div>

    <!-- Actions -->
    <div class="var-actions">
        <button class="btn-primary" id="varCopyBtn">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            Copy Output
        </button>
        <button class="btn-secondary" id="varClearBtn">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Clear
        </button>
    </div>

</div>
</div>

<script src="../js/main.js"></script>
<script>
/* ================================================================
   AUTO DUPLICATE WORD VARIATOR â€” v3
   Changes:
   - Slider removed (always 3rd occurrence threshold)
   - Layout: right-side extra panel removed
   - DELETE logic for unconvertible stop-words (3rd+ occurrence removed)
   - Ctrl+V anywhere = auto paste into input
   - Click output box = copy
   ================================================================ */

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SAFE UNICODE MAP
// Only confirmed safe on Amazon EU (UK/DE/NL/IT/ES/SE) â€” no "?" risk
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SAFE_MAP = {
    'a': ['Ã ','Ã¢','Ä'],
    'c': ['Ã§','Ä‡'],
    'e': ['Ã¨','Ãª','Ã«','Ä“'],
    'i': ['Ã¬','Ã®','Ã¯','Ä«'],
    'l': ['Äº','Ä¼'],
    'n': ['Ã±','Å„'],
    'o': ['Ã²','Ã´','Ã¶','Å','Ã¸'],
    'r': ['Å•'],
    's': ['Å›','Å¡','ÅŸ'],
    't': ['Å£','Å¥'],
    'u': ['Ã¹','Ã»','Ã¼','Å«'],
    'y': ['Ã¿','Ã½'],
    'z': ['Åº','Å¾','Å¼'],
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DELETE-WORDS (words that CANNOT be Unicode-varied)
// These are common connectors/articles in each language.
// Rule: first 2 occurrences kept as-is, 3rd+ occurrence DELETED
// (along with the surrounding whitespace to keep spacing clean).
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DELETE_WORDS = new Set([
    // English
    'and','for','the','or','a','an','of','in','on','at','to','by',
    'with','from','as','is','it','be','its','nor','so','yet','up',
    // German
    'und','der','die','das','dem','den','des','ein','eine','oder',
    'mit','von','fur','zu','im','am','aus','auf','bei','nach',
    'zum','zur','vom','ins','ans','als','wie','aber',
    // French
    'les','pour','des','une','avec','dans','sur','par','que',
    'qui','est','son','ses','aux','au','du','ou','ne','ce',
    // Spanish
    'del','los','las','y','una','per','con','por','para','que',
    'una','unos','sus','sin','mas','ya','ni','al','se','su',
    // Italian
    'di','del','dei','degli','delle','della','con','tra','fra',
    'una','per','che','gli','non','col','ai','agli','alle',
    // Dutch
    'voor','van','het','een','met','van','aan','bij','tot',
    'uit','door','als','om','ze','via','over',
    // Swedish
    'for','och','att','som','men','det','den','ett','har',
    'till','eller','om','av','vid','sin','sig','pa','med',
]);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VARY-STOP WORDS (words that CAN potentially be varied but are
// too common/grammatical to look right varied â€” kept as-is always)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VARY_STOP = new Set([
    // These stay unchanged no matter how many times they appear
    // (they are NOT deleted either â€” only DELETE_WORDS get deleted)
    // Placeholder for future expansion if needed
]);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TITLE CASE â€” minor words stay lowercase
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TITLE_MINOR = new Set([
    // English
    'a','an','the','and','but','or','for','nor','so','yet',
    'at','by','in','of','on','to','up','as','via',
    // Spanish
    'de','del','al','el','la','los','las','un','una','unos','unas',
    'o','en','con','por','para','que','se','su','sus','lo',
    'ni','sin','ante','bajo','tras','entre','hacia','desde','sobre',
    // Italian
    'di','da','il','lo','gli','le','un','una','del','della','dei',
    'degli','delle','e','ed','o','ma','che','si','ci','col','al',
    'ai','agli','alle','fra','tra','con','su','per',
    // French
    'du','des','au','aux','et','ou','ne','ni','car','par','sur',
    'dans','avec','sous','vers','chez',
    // German
    'der','die','das','dem','den','ein','eine','eines','einer',
    'und','oder','aber','doch','im','am','zum','zur','vom',
    'beim','ins','ans','ums','wie','als',
    'fur',  // fÃ¼r â†’ toPlainASCII â†’ fur
    // Dutch
    'het','een','van','voor','met','op','te','aan','bij','tot',
    'uit','door','als','om','ze','via','per',
    // Swedish
    'den','det','ett','av','fÃ¶r','med','pÃ¥','till','och','eller',
    'att','Ã¤r','om','hos','vid','kring',
    'for','pa','ar', // ASCII versions of fÃ¶r, pÃ¥, Ã¤r after toPlainASCII
]);

const ALLCAPS_WORDS = new Set([
    'abs','ean','usb','led','diy','uv','hd','4k','2k','xl','xxl',
    'lp','cd','dvd','pc','dna','iq',
]);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toPlainASCII(str) {
    return str.normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]/g, '');
}

function normalizeKey(w) {
    return w.normalize('NFC').toLowerCase().replace(/[^\p{L}\p{N}]+/gu, '');
}

// Tokenize preserving whitespace as separate tokens
function tokenize(text) {
    return text.match(/\S+|\s+/g) || [text];
}

// Count word frequencies
function countWords(tokens) {
    const counts = {};
    const originals = {};
    for (const tok of tokens) {
        if (!/\p{L}/u.test(tok)) continue;
        const key = normalizeKey(tok);
        if (!key) continue;
        counts[key] = (counts[key] || 0) + 1;
        if (!originals[key]) originals[key] = tok;
    }
    return { counts, originals };
}

// Check if a word has any character that can be Unicode-varied
function canBeVaried(word) {
    const lower = word.toLowerCase();
    for (const ch of lower) {
        if (SAFE_MAP[ch]) return true;
    }
    return false;
}

// Apply one Unicode replacement to a token
function applyVariation(token) {
    const lower = token.toLowerCase();
    const chars = [...lower];
    const candidates = [];
    for (let i = 0; i < chars.length; i++) {
        if (SAFE_MAP[chars[i]]) candidates.push(i);
    }
    if (candidates.length === 0) return token;

    const idx = candidates[Math.floor(Math.random() * candidates.length)];
    const opts = SAFE_MAP[chars[idx]];
    const repl = opts[Math.floor(Math.random() * opts.length)];

    const origChar = token[idx];
    const isUpper = origChar === origChar.toUpperCase() && origChar !== origChar.toLowerCase();
    chars[idx] = isUpper ? repl.toUpperCase() : repl;

    let result = '';
    for (let i = 0; i < chars.length; i++) {
        result += (i === idx) ? chars[i] : (token[i] ?? chars[i]);
    }
    return result;
}

// Title case conversion
// Rules:
//  - If original token was ALL CAPS (e.g. WATERPROOF) â†’ keep ALL CAPS
//  - Minor words in middle of title â†’ lowercase
//  - First word or word after separator â†’ capitalize first letter
//  - Hyphenated â†’ each part capitalize
function toTitleCase(str) {
    const tokens = str.match(/[|\-â€“â€”:,]|[\s]+|[^\s|\-â€“â€”:,]+/g) || [];
    let capNext = true;
    return tokens.map(tok => {
        if (/^\s+$/.test(tok)) return tok;
        if (/^[|\-â€“â€”:,]$/.test(tok)) { capNext = true; return tok; }

        const lower = tok.toLowerCase();
        const plain = toPlainASCII(lower);

        // Hardcoded ALL-CAPS acronyms always uppercase
        if (ALLCAPS_WORDS.has(plain)) { capNext = false; return tok.toUpperCase(); }

        // If the ORIGINAL token was written in ALL CAPS by the user â†’ preserve it
        // (check: every letter in token is uppercase and token has at least 2 letters)
        const letters = tok.replace(/[^a-zA-ZÃ€-Å¾Ã€-Ã¿]/g, '');
        if (letters.length >= 2 && letters === letters.toUpperCase()) {
            capNext = false;
            return tok; // e.g. WATERPROOF, LIQUID, FAUX â†’ stays as-is
        }

        // Minor word in MIDDLE of title â†’ always lowercase (fÃ¼r stays fÃ¼r, not FÃ¼r)
        if (!capNext && TITLE_MINOR.has(plain)) { capNext = false; return lower; }

        // Hyphenated word â†’ capitalize each part
        if (tok.includes('-')) {
            const r = tok.split('-').map(p => {
                if (!p) return p;
                const pl = p.toLowerCase();
                return pl.charAt(0).toUpperCase() + pl.slice(1);
            }).join('-');
            capNext = false; return r;
        }

        // Normal word â†’ capitalize first letter only
        capNext = false;
        return lower.charAt(0).toUpperCase() + lower.slice(1);
    }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN TRANSFORM
// Threshold is fixed at 3 (3rd+ occurrence gets treated)
// DELETE_WORDS: 3rd+ occurrence â†’ token + its preceding space deleted
// Other words: 3rd+ occurrence â†’ Unicode varied
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const THRESHOLD = 3;

function transformTokens(tokens, counts) {
    const seen = {};
    // We'll build output as array of {value, delete} objects first
    // then clean up spaces around deleted tokens
    const out = [];

    for (let i = 0; i < tokens.length; i++) {
        const raw = tokens[i];

        // Whitespace token â€” add as-is for now, may be removed later
        if (!/\p{L}/u.test(raw)) {
            out.push({ value: raw, isSpace: true, deleted: false });
            continue;
        }

        const key   = normalizeKey(raw);
        if (!key) { out.push({ value: raw, isSpace: false, deleted: false }); continue; }

        const plain = toPlainASCII(key);
        seen[key] = (seen[key] || 0) + 1;
        const nth = seen[key];

        // First two occurrences of any word â†’ always keep unchanged
        if (nth < THRESHOLD) {
            out.push({ value: raw, isSpace: false, deleted: false });
            continue;
        }

        // 3rd+ occurrence:
        if (DELETE_WORDS.has(plain)) {
            // DELETE this word (mark it, we'll also remove the adjacent space)
            out.push({ value: raw, isSpace: false, deleted: true });
        } else {
            // Try to Unicode-vary it
            const varied = applyVariation(raw);
            out.push({ value: varied, isSpace: false, deleted: false });
        }
    }

    // Clean up: for each deleted word token, also remove the space immediately before it
    // (to prevent double spaces in output)
    const cleaned = [];
    for (let i = 0; i < out.length; i++) {
        if (out[i].deleted) {
            // Remove preceding whitespace token if present
            if (cleaned.length > 0 && cleaned[cleaned.length - 1].isSpace) {
                cleaned.pop();
            }
            // Skip this deleted word
            continue;
        }
        cleaned.push(out[i]);
    }

    return cleaned.map(t => t.value);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANALYSIS PANEL
// Shows words that appear 3+ times, with their action label
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TAG_COLORS = [
    '#7c3aed','#2563eb','#059669','#dc2626','#d97706',
    '#0891b2','#db2777','#4f46e5','#16a34a','#b45309'
];

function renderDupInfo(counts) {
    const dups = Object.entries(counts)
        .filter(([, c]) => c >= THRESHOLD)
        .sort((a, b) => b[1] - a[1]);

    if (dups.length === 0) {
        dupInfo.innerHTML = '<p class="no-dup">âœ“ No duplicates found at 3+ threshold.</p>';
        return;
    }

    let html = '<ul>';
    dups.forEach(([key, count], i) => {
        const color = TAG_COLORS[i % TAG_COLORS.length];
        const plain = toPlainASCII(key);
        const isDelete = DELETE_WORDS.has(plain);
        const actionLabel = isDelete ? 'delete 3rd+' : 'vary 3rd+';
        const actionClass = isDelete ? 'deleted' : 'varied';
        html += `<li>
            <span class="dup-tag" style="background:${color}20;color:${color};border:1px solid ${color}35;">
                ${key}
            </span>
            <span style="color:rgba(255,255,255,.4);font-size:.8rem;">Ã—${count}</span>
            <span class="dup-action ${actionClass}">${actionLabel}</span>
        </li>`;
    });
    html += '</ul>';
    dupInfo.innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DOM REFS & COUNTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const varInput  = document.getElementById('varInput');
const varOutput = document.getElementById('varOutput');
const dupInfo   = document.getElementById('dupInfo');

function updateCounts() {
    const inp    = varInput.value;
    const out    = varOutput.value;
    const inLen  = inp.length;
    const outLen = out.length;
    const words  = inp.trim() ? inp.trim().split(/\s+/).length : 0;

    document.getElementById('inputCharCount').textContent  = inLen;
    document.getElementById('inputWordCount').textContent  = words;
    document.getElementById('outputCharCount').textContent = outLen;

    const inLabel = document.getElementById('inputCharLabel');
    inLabel.textContent = `${inLen} / 200 characters`;
    inLabel.parentElement.className = 'char-row' + (inLen > 200 ? ' over' : '');
    document.getElementById('inputOverWarn').style.display = inLen > 200 ? 'inline' : 'none';

    const outLabel = document.getElementById('outputCharLabel');
    outLabel.textContent = `${outLen} / 200 characters`;
    outLabel.parentElement.className = 'char-row' + (outLen > 200 ? ' over' : '');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN PROCESS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function processVariator() {
    const text = varInput.value;

    if (!text.trim()) {
        varOutput.value = '';
        dupInfo.innerHTML = '<p class="dup-empty">Paste a title to see analysis.</p>';
        updateCounts();
        return;
    }

    const tokens = tokenize(text);
    const { counts } = countWords(tokens);

    renderDupInfo(counts);

    const transformed = transformTokens(tokens, counts);
    varOutput.value = toTitleCase(transformed.join(''));

    updateCounts();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COPY HELPER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyOutput() {
    const out = varOutput.value;
    if (!out.trim()) { showToast('Nothing to copy', true); return; }
    const wrap = document.getElementById('outputWrap');
    navigator.clipboard.writeText(out)
        .then(() => {
            showToast('âœ“ Output copied!');
            wrap.classList.add('copied');
            setTimeout(() => wrap.classList.remove('copied'), 1200);
        })
        .catch(() => {
            const t = document.createElement('textarea');
            t.value = out; document.body.appendChild(t);
            t.select(); document.execCommand('copy');
            document.body.removeChild(t);
            showToast('âœ“ Output copied!');
            wrap.classList.add('copied');
            setTimeout(() => wrap.classList.remove('copied'), 1200);
        });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EVENTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Live typing â€” debounced
let typingDelay;
varInput.addEventListener('input', () => {
    clearTimeout(typingDelay);
    typingDelay = setTimeout(processVariator, 80);
});

// Ctrl+V ANYWHERE on page â†’ REPLACE input content (never append)
document.addEventListener('paste', (e) => {
    const text = (e.clipboardData || window.clipboardData).getData('text');
    if (!text || !text.trim()) return;
    // Always intercept paste â€” whether focused on input or anywhere else
    // This ensures re-paste always replaces, not appends
    e.preventDefault();
    varInput.value = text.trim();
    varInput.focus();
    processVariator();
    showToast('âœ“ Title pasted!');
});

// Click on output box â†’ copy
document.getElementById('outputWrap').addEventListener('click', copyOutput);

// Copy button
document.getElementById('varCopyBtn').addEventListener('click', (e) => {
    e.stopPropagation(); // prevent double-fire if button is inside outputWrap
    copyOutput();
});

// Clear button
document.getElementById('varClearBtn').addEventListener('click', () => {
    varInput.value = '';
    varOutput.value = '';
    dupInfo.innerHTML = '<p class="dup-empty">Paste a title to see analysis.</p>';
    document.getElementById('outputWrap').classList.remove('copied');
    updateCounts();
    showToast('Cleared!');
});

// Init
updateCounts();
</script>
</body>
</html>
